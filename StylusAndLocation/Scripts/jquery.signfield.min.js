!function(e){"use strict";var t=e.sketch.tools.marker,a=t.draw;t.draw=function(e){var t,r,n=[],i=this.canvas;for(t=0;t<e.events.length;t++)r=e.events[t],"drawImage"==r._type?(this.context.drawImage(r.image,0,0),setTimeout(function(){i.trigger("change")},1e3)):n.push(r);({context:this.context,draw:a}).draw(e)};var r=function(){var e=document.createElement("canvas");return!(!e.getContext||!e.getContext("2d"))},n=function(e){var t="object"!=typeof signField_I18N?null:signField_I18N[e];return t||"?"+e+"?"},i=function(t,a,r){var n=t.data("errors");return t.hasClass("has-error")||t.addClass("has-error"),e(".message",t).text(r),""!=e.trim(n)?t.data("errors",n+","+a):t.data("errors",a),t},s=function(t){var a=new Image;e(a).load(function(){var e=t.sketch().actions;e.push({tool:"marker",events:[{_type:"drawImage",image:this}]}),t.sketch("actions",e),t.sketch("redraw")}).attr("src",_sample)};e.fn.signField=function(t){var a=e(this);if("errors"==t){var c=[];return a.each(function(t,a){var r=e(a);if("yes"!=r.data("signature"))return!0;var n=r.data("errors");return""==e.trim(n)?!0:void(c=c.concat(n))}),c}if("filename"==t){var o=e('input[type="file"]',this).first();return 0==o.length?null:o.val()}var l=arguments;if("imagedata"==t&&l&&l.length>=2)return e(this).each(function(t,a){s(e("canvas",a),l[1])});if("imagedata"==t){var d=e(".imgdata",this).first();return 0==d.length?null:d.val()}if("selectiontype"==t){var u=e('input[type="radio"]:checked').first();return 0==u.length?null:u.val()}if(l&&l.length>=2){var h=l[0];if("addError"==h&&l.length>=3){var f=e(this).first();return 1!=f.length?f:i(f,l[1],l[2])}return a}var v=[];return a.each(function(t,a){var s=e(a),c=s.attr("id"),o=s.data("name"),l=s.attr("class"),d=e('<div class="'+l+'" id="'+c+'" data-signature="yes"></div>'),u=r()?e("<canvas></canvas>").appendTo(d):null,h=e('<input type="file" name="'+o+'-file" />').appendTo(d),f=h.get(0),g=e('<span class="message"></span>').appendTo(d),p=e('<div style="width:1in;height:1px"></div>').appendTo(d),m=e('<input type="hidden" />').appendTo(d),k=function(){return!0};if(f.files)try{var y=parseInt(s.data("max-size"));k=function(){var e=0==f.files.length?0:f.files[0].size/1024;e>y?i(d,"file.error.maxSize",n("file.error.maxSize").replace("{0}",e).replace("{1}",y)):(d.removeClass("has-error"),g.text(""))}}catch(s){}if(u){var w=s.data("pen-tickness")||2,x=e('<input type="hidden" class="imgdata" value="" />').appendTo(d),b=u.get(0),C=s.data("width"),I=s.data("height"),T=function(){x.attr("name",o).val(b.toDataURL()),h.removeAttr("name"),m.attr("name",o+"-dpi");var t="",a=d.data("errors");""!=e.trim(a)&&e.each(a.split(","),function(a,r){return r&&r.length>11&&"file.error."==r.substring(0,11)?!0:void(""!=e.trim(r)&&(t+=r))}),d.data("errors",t),""==t&&d.removeClass("has-error")},z=function(){x.removeAttr("name"),h.attr("name",o),m.attr("name",""),k()},_=e('<input type="radio" name="'+o+'-type" value="canvas" />').click(T),A=e('<input type="radio" name="'+o+'-type" value="file" />'),B=C||u.width(),F=I||u.height();A.change(function(){return""==e.trim(h.val())?(A.removeAttr("checked"),!1):void z()}),B&&u.attr("width",B),F&&u.attr("height",F),u.sketch({defaultColor:s.data("pen-color")||s.css("color")||"black",defaultSize:w}).on("change click mousedown mouseup touchstart touchmove touchend touchcancel",function(){_.trigger("click"),d.trigger("change")}),e('<label class="radio sketch-radio">'+n("sketch.label")+"</label>").prepend(_).insertBefore(u),e('<a href="#clear" class="clear-canvas">'+n("sketch.clear")+"</a>").insertBefore(u).click(function(){return b.getContext("2d").clearRect(0,0,B,F),u.sketch("actions",[]),!1}),e('<label class="radio file-radio">'+n("file.label")+"</label>").prepend(A).insertBefore(h),h.change(function(){A.trigger("click")})}else h.attr("name",o);h.change(function(){k(),d.trigger("change")}),s.replaceWith(d),m.val(p.width()),p.remove(),v.push(d.get(0))}),e(v)}}(jQuery);
